#!/usr/bin/env node

/*!
 * Pad Repository
 *
 * Copyright(c) 2013-2014 Dirección de Tecnología Educativa de Buenos Aires (Dte-ba)
 * GPL Plublic License v3
 */

var fs = require('fs')
  , repository = require('../lib/pad-repository')
  , cmd = require('../lib/utils/cmd-prompt')
  , io = require('../lib/utils/io');

// usage docs
var usage = [
    ''
  , '  PAD repository manager'
  , ''
  , '  Usage: pad-repository <command> <path>|<filename>'
  , ''
  , '  where <command> is one of:'
  , '        init cache clear check show watch'
  , ''
  , ' Actions:'
  , ''
  , '    -v, --version             Display a version of pad-repository'
  , '    -h, --help                Display this text'
  , '    -f, --force               Force the command'
  , '    --buffer-size             The buffer size to procces packages (5 as default)'
  , ''
].join('\n');

var _init = new Date();

/**
 * Input/output path
 */
var _path = '.';

/**
 * An action to call 
 *    like: init, cache, clear, check
 */
var action = ''

/**
 * Override flag
 */
var withForce = false;

/**
 * Buffer size
 */
var bufferSize = 5;

/*
 * Proccess arguments
 */
var args = process.argv.slice(2);

// give me args
if (!args.length) { cmd.abort(usage); }

// procces args
var arg;
while (args.length) {
  arg = args.shift();
    switch (arg) {
    case '-h':
    case '--help':
      cmd.abort(usage);
    case '-v':
    case '--version':
      cmd.abort(repository.version);
      break;
    case '-f':
    case '--force':
      withForce = true;
      break;
    case '--buffer-size':
      withForce = true;
      (args.length) 
        ? (bufferSize = parseInt(args.shift()))
        : cmd.abort('--buffer-size requires an argument');
      break;
    case 'init':
      action = 'init';
      break;
    case 'check':
      action = 'check';
      break;
    case 'watch':
      action = 'watch';
      break;
    case 'cache':
      action = 'cache';
      break;
    case 'clear':
      action = 'clear';
      break;
    case 'show':
      action = 'show';
      break;
    default:
      _path = arg;
  }
}

// check the action
if ( !(/^(init|cache|clear|check|show|watch)$/i).test(action) ) {
  console.log('the action `' + action + '` was not found.');
  cmd.abort(usage);
}

// options
var options = {
  action: action,
  path: _path ,
  withForce: withForce,
  bufferSize: bufferSize
};

// just do it
(function(repo, ops){

  // the function will be executed
  // if something wrong abort with a Unexpected error
  var befn = function() {
    cmd.abort('Unexpected error.');
  };

  // the ending function
  var endfn = function(err) { 
     if (err) {
        cmd.abort(err); 
     }
     
     var _ends = new Date();
     var diff = _ends - _init;

     if (!repo.isWatching) {
      console.log('');
      console.log('complete on', diff, 'miliseconds'); 
     }
  };

  var action = ops.action,
      opsP = {
        path: ops.path,
        withForce: ops.withForce,
        bufferSize: ops.bufferSize
      };

  switch (action) {
  case 'init':
    befn = repo.init;
  break;
  case 'check':
    befn = repo.check;
  break;
  case 'watch':
    befn = repo.watch;
  break;
  case 'cache':
    befn = repo.cache;
  break;
  case 'clear':
    befn = repo.clear;
  break;
  case 'show':
    befn = repo.show;
  break;
  default:
    cmd.abort('Oop! the action `' + action + '` was not expected.');
  }

  befn.apply(repo, [opsP, endfn]);
  
})(repository, options)